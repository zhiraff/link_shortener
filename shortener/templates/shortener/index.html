{% extends 'base.html' %}

{% block title %} {{ block.super }} :: главная{% endblock %}

{% block content %}
<div class="card">
  <h1 class="card-title">Сократите длинную ссылку</h1>
  <p class="card-subtitle">
    Вставьте длинный URL в поле ниже и получите короткую ссылку clck.ru.
  </p>

  {# Основная форма: вставка URL и кнопка "Сократить" #}
  <form method="post" class="main-form" id="shorten-form">
    {% csrf_token %}
    <input
      type="url"
      name="url"
      class="url-input"
      placeholder="https://пример-длинной-ссылки.ru/..."
      required
    >
    <button type="submit" class="btn-primary">
      Сократить
    </button>
  </form>

  <div id="shorten-result" class="ajax-result" style="display:none; opacity:0; transform: translateY(12px); margin-top: 18px;">
    {# сюда JS будет подставлять результат / ошибку #}
  </div>

  <hr class="section-divider">

  <section class="upload-section">
    <h2 class="upload-section-title">Сократить ссылки из XLSX‑файла</h2>
    <p class="upload-section-text">
      Загрузите таблицу в формате .xlsx с перечнем ссылок — мы сократим их пакетно.
    </p>

    {# Вторая форма для загрузки XLSX‑файла #}
    <form method="post" enctype="multipart/form-data" class="upload-form" id="xlsx-form">
      {% csrf_token %}
      <label class="file-input">
        <input
          type="file"
          name="xlsx_file"
          accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          required
        >
        <span class="file-input-label">Выберите XLSX‑файл…</span>
      </label>

      <button type="submit" name="upload_xlsx" class="btn-secondary">
        Отправить файл
      </button>
    </form>

    <div id="xlsx-result" class="ajax-result" style="display:none; opacity:0; transform: translateY(12px); margin-top: 12px;">
      {# сюда JS будет подставлять результат / ошибку #}
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function showResult(element, html) {
    element.innerHTML = html;
    element.style.display = 'block';
    requestAnimationFrame(function () {
      element.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
      element.style.opacity = '1';
      element.style.transform = 'translateY(0)';
    });
  }

  function clearResult(element) {
    element.style.display = 'none';
    element.style.opacity = '0';
    element.style.transform = 'translateY(12px)';
    element.innerHTML = '';
  }

  document.addEventListener('DOMContentLoaded', function () {
    const shortenForm = document.getElementById('shorten-form');
    const shortenResult = document.getElementById('shorten-result');
    const xlsxForm = document.getElementById('xlsx-form');
    const xlsxResult = document.getElementById('xlsx-result');
    const csrftoken = getCookie('csrftoken');

    if (shortenForm) {
      shortenForm.addEventListener('submit', function (e) {
        e.preventDefault();
        clearResult(shortenResult);

        const formData = new FormData(shortenForm);

        fetch(window.location.href, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
          },
          body: formData
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (data.error) {
              showResult(shortenResult, '<p class="upload-section-text" style="color:#b91c1c;">' + data.error + '</p>');
              return;
            }

            var html =
              '<div class="shorten-result-box">' +
                '<div class="shorten-result-row">' +
                  '<div class="shorten-result-left">' +
                    '<a href="' + data.short_url + '" target="_blank" class="shorten-result-link">' + data.short_url + '</a>' +
                    '<button type="button" class="btn-secondary" id="copy-short-url-btn">Копировать ссылку</button>' +
                  '</div>' +
                  '<div class="shorten-result-qr">' +
                    '<img src="' + data.qr_code_url + '" alt="QR код" />' +
                  '</div>' +
                '</div>' +
                '<div class="shorten-result-meta">' +
                  'Дата создания: ' + data.created_at + ' · Переходов: ' + data.clicks +
                '</div>' +
              '</div>';

            showResult(shortenResult, html);

            const copyBtn = document.getElementById('copy-short-url-btn');
            if (copyBtn && navigator.clipboard) {
              copyBtn.addEventListener('click', function () {
                navigator.clipboard.writeText(data.short_url);
              });
            }
          })
          .catch(function () {
            showResult(shortenResult, '<p class="upload-section-text" style="color:#b91c1c;">Произошла ошибка при запросе.</p>');
          });
      });
    }

    if (xlsxForm) {
      xlsxForm.addEventListener('submit', function (e) {
        e.preventDefault();
        clearResult(xlsxResult);

        const formData = new FormData(xlsxForm);

        fetch(window.location.href, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
          },
          body: formData
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (data.error) {
              showResult(xlsxResult, '<p class="upload-section-text" style="color:#b91c1c;">' + data.error + '</p>');
              return;
            }

            var html =
              '<p class="upload-section-text">' +
                'Готово. <a href="' + data.download_url + '">Скачать обработанный файл</a>.' +
              '</p>';

            showResult(xlsxResult, html);
          })
          .catch(function () {
            showResult(xlsxResult, '<p class="upload-section-text" style="color:#b91c1c;">Произошла ошибка при загрузке файла.</p>');
          });
      });
    }
  });
</script>
{% endblock %}
